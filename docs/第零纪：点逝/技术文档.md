# 第零纪：点逝

技术实现文档 v1.0

---

## 1. 文档目的

供开发与维护者快速理解“点逝”最小生命体的代码结构、状态机、持久化方案与异常处理策略。

---

## 2. 运行环境

- 解释器：CPython 3.8+
- 操作系统：跨平台（Windows / macOS / Linux）
- 依赖：仅 Python 标准库（`time`, `json`, `signal`）

---

## 3. 代码结构（单文件：`epoch0/dot.py`）

| 行号区间 | 作用域   | 说明                                                  |
| -------- | -------- | ----------------------------------------------------- |
| 1-3      | import   | 引入 `time`, `json`, `signal`, `sys`                  |
| 5-8      | 常量区   | `STEP = 0.01` 递减步长；`INTERVAL = 1.0` 秒级 tick    |
| 10-18    | 持久化层 | `load()/save()` 原子写：先写临时文件再 `os.replace()` |
| 20-25    | 优雅退出 | 注册 `SIGINT` 处理，保证 Ctrl-C 时立即 `save()`       |
| 27-40    | 主循环   | while `dot > 0`：打印、递减、保存、睡眠               |
| 42-45    | 死亡出口 | 打印蒸发信息，退出码 0                                |

---

## 4. 状态模型

```
dot ∈ ℝ, 1.00 → 0.00
tickₙ = ⌊(1.0 - dotₙ) / STEP⌋
```

- 无分支状态机，仅线性递减。
- 唯一外部可观测副作用：stdout 与 json 文件。

---

## 5. 持久化格式（dot.json）

```json
{
  "dot": 0.67,
  "tick": 33
}
```

- 采用紧凑写法，无换行，减少写盘次数。
- 写盘频率：每 tick 一次（1 Hz），写放大可忽略。

---

## 6. 原子写实现

```python
tmp = f"{path}.tmp"
with open(tmp, "w") as f:
    json.dump(data, f)
os.replace(tmp, path)   # POSIX/Win 均原子
```

- 保证断电瞬间文件完整性。

---

## 7. 异常与信号处理

| 场景                 | 行为                                                     |
| -------------------- | -------------------------------------------------------- |
| Ctrl-C               | 捕获 `KeyboardInterrupt`，先 `save()` 再 `sys.exit(0)`   |
| kill -9 / 断电       | 可能丢失**当前** tick，但 json 不损坏，重启续传          |
| 手动改 json 为非法值 | 启动时 `json.JSONDecodeError` 抛出，程序崩溃提示清理文件 |
| 值已 ≤0              | 立即打印死亡信息并退出，不再写盘                         |

---

## 8. 性能与资源

- CPU：单核 <1%（1 Hz 循环）
- 内存：≈ 8 MB（Python 解释器本身占大部分）
- 磁盘：每天 86 KB 写流量（24×60×60×1 字节）

---

## 9. 测试用例（本地验收清单）

1. **正常递减**  
   `python dot.py` → 观察到 1.00 → 0.00 共 101 行，末行出现蒸发提示。
2. **中断续传**  
   运行到 0.42 时 Ctrl-C；再次运行，首行输出 `dot = 0.42` 并继续递减。
3. **边界值**  
   手动改 json 为 `0.009`，启动后应直接打印蒸发并退出。
4. **非法文件**  
   改 json 为 `{broken}`，启动报错提示用户删除文件。

---

## 10. 后续可扩展点（本版本预留）

- 把 STEP / INTERVAL 提到环境变量，实现“加速消亡”模式。
- 把 stdout 改为可选日志级别，便于后续管道分析。
- 死亡后自动生成 `dot.log` 记录存活总 tick，供可视化引用。

---

## 11. 版本历史

| 版本 | 日期       | 说明                       |
| ---- | ---------- | -------------------------- |
| v1.0 | 2025-10-15 | 初版，支持最小递减与持久化 |
